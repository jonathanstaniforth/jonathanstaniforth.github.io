I"s#<p>Only one container or service deployed using docker can use a port on the host machine at any given time, meaning, each container has to use a different port to be accessed. But, in certain situations, we may want several containers to use the same port, for example when using domain names to access containers. Additionally, this problem grows as the scale and complexity of docker services and swarms increases.</p>

<p>To solve this problem, we can use nginx as a proxy, listening to a particular port and sending traffic onwards to the appropraite container or service. This post discusses how to do this in both a single stack and multi-stack scenario, with nginx listening on port 80.</p>

<h2 id="single-stack-scenario">Single stack scenario</h2>
<p>In this scenario, a docker swarm is setup and two services are available, both using port 80 internally in the container. The docker compose file for this stack looks like the below:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">version</span><span class="pi">:</span> <span class="s2">"</span><span class="s">3.7"</span>
<span class="na">services</span><span class="pi">:</span>
    <span class="na">frontend</span><span class="pi">:</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">frontend:latest</span>
        <span class="na">init</span><span class="pi">:</span> <span class="no">true</span>
    
    <span class="na">api</span><span class="pi">:</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">api:latest</span>
        <span class="na">init</span><span class="pi">:</span> <span class="no">true</span>
</code></pre></div></div>

<p>Now, the nginx service is introduced into the stack, binding to port 80. The service will be added to the compose file as an additional service like follows:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="na">nginx</span><span class="pi">:</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">nginx</span>
        <span class="na">init</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">volumes</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">./conf.d:/etc/nginx/conf.d</span>
        <span class="na">ports</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">80:80</span>
</code></pre></div></div>

<p>Since the nginx service is ready, we can create the nginx configuration file, called <strong>example.conf</strong>, and place it in the folder <strong>./conf.d</strong> on the host machine. The file contains two sections for the frontend and api services, which are accessable via a domain. In this example, the stack is named as <strong>example</strong> and, therefore, the servicesâ€™ domains are <strong>http://example_&lt;service_name&gt;:80</strong>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>server {
    listen 80;

    server_name example.com;
    
    location / {
        proxy_pass http://example_frontend:80;
    }
}

server {
    listen 80;

    server_name api.example.com;

    location / {
        proxy_pass http://example_api:80;
    }
}
</code></pre></div></div>

<p>This file will be mounted into the container and read by nginx when the stack is deployed, as follows:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker stack deploy <span class="nt">-c</span> docker-compose.yml example
</code></pre></div></div>

<p>This example showed how to setup an nginx service in a stack to route to services that both require port 80.</p>

<h2 id="multi-stack-scenario">Multi-stack scenario</h2>
<p>A more complex situation may arise when the nginx service has to route to services that are separated into different stacks. Below discusses how to configure the nginx service to handle such a situation. In this example, we start with two stacks, each containing one service like so:</p>

<ul>
  <li>Stack 1
    <ul>
      <li>frontend: http://example.com</li>
    </ul>
  </li>
  <li>Stack 2
    <ul>
      <li>api: http://api.example.com</li>
    </ul>
  </li>
</ul>

<p>To allow the nginx service to access the service found in each stack, the overlay network for the stacks needs to be exposed. This can be achieved by making the overlay network attachable and connecting the service to that network, as shown below in the compose file for stack 1:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">version</span><span class="pi">:</span> <span class="s2">"</span><span class="s">3.7"</span>
<span class="na">services</span><span class="pi">:</span>
    <span class="na">frontend</span><span class="pi">:</span>
        <span class="na">networks</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">overlay</span>

<span class="na">networks</span><span class="pi">:</span>
    <span class="na">overlay</span><span class="pi">:</span>
        <span class="na">driver</span><span class="pi">:</span> <span class="s">overlay</span>
        <span class="na">attachable</span><span class="pi">:</span> <span class="no">true</span>
</code></pre></div></div>

<p>This Compose file is similarly repeat for Stack 2 as well, but contains the api service rather than the frontend service. The stacks are then deployed to the swarm like so:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker stack deploy <span class="nt">-c</span> docker-compose-stack1.yml stack1

docker stack deploy <span class="nt">-c</span> docker-compose-stack2.yml stack2
</code></pre></div></div>

<p>Next, the nginx service is added to the swarm by deploying a separate stack with this service. This service then attaches to the overlay network of stack1 and stack2, allowing it to access the services found within.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">version</span><span class="pi">:</span> <span class="s2">"</span><span class="s">3.7"</span>
<span class="na">services</span><span class="pi">:</span>
    <span class="na">nginx</span><span class="pi">:</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">nginx</span>
        <span class="na">init</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">volumes</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">./conf.d:/etc/nginx/conf.d</span>
        <span class="na">ports</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">80:80</span>
        <span class="na">networks</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">overlay</span>
            <span class="pi">-</span> <span class="s">stack1_overlay</span>
            <span class="pi">-</span> <span class="s">stack2_overlay</span>

<span class="na">networks</span><span class="pi">:</span>
    <span class="na">overlay</span><span class="pi">:</span>
        <span class="na">driver</span><span class="pi">:</span> <span class="s">overlay</span>
        <span class="na">attachable</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">stack1_overlay</span><span class="pi">:</span>
        <span class="na">external</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">stack1_overlay</span>
    <span class="na">stack2_overlay</span><span class="pi">:</span>
        <span class="na">external</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">stack2_overlay</span>
</code></pre></div></div>

<p>The configuration file for nginx is shown below:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>server {
    listen 80;

    server_name example.com;
    
    location / {
        proxy_pass http://stack1_frontend:80;
    }
}

server {
    listen 80;

    server_name api.example.com;

    location / {
        proxy_pass http://stack2_api:80;
    }
}
</code></pre></div></div>

<p>Finally, the nginx stack is deployed alongside the other two stacks as follows:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker stack deploy <span class="nt">-c</span> docker-compose-nginx.yml nginx
</code></pre></div></div>

<p>This example showed how to expand upon the single stack example, deploying an nginx service that resides inside its own stack. This allows the nginx service to attach to stack networks to access the services inside and route traffic appropriately.</p>
:ET