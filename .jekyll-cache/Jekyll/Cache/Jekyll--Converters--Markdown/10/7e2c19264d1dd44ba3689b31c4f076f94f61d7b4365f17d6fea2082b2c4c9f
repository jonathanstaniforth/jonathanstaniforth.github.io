I"¢<p>In a recent move of offices, we had to stop our GitLab docker container and
decided to take the opportunity to improve the storage of our git repositories.
Instead of storing our git repositories on a desktop computer thatâ€™s acting as a
server, we wanted to move them to a Network Access Storage (NAS).
This NAS is by <a href="https://www.synology.com/">Synology</a> and has been set up with RAID to automatically backup data stored on the device,
providing us with better resilience against storage failure.
Additionally, it provides some optimisations in data transfer and storage, which
the standard desktop doesnâ€™t have.</p>

<p>However, the difficulty comes when trying to transfer the repositories as GitLab stores secrets to encrypt the repositories.
When searching for how to transfer the repositories, many different methods
appeared for the different possible GitLab setups.
Therefore, this post shows the process that we followed to successfully
transfer our repositiories from one GitLab docker container to another.</p>

<blockquote>
  <p>This post assumes that the GitLab version is 12.6.</p>
</blockquote>

<h2 id="backup">Backup</h2>
<p>The first step is to backup the repositories on the old server, which in this
case are stored on the host machine and bind-mounted into the GitLab docker container.
To do this, we must enter the container and use a gitlab command to generate the
backup as a tar file, storing it into a bind-mounted folder so that we can access it from the host machine.</p>

<p>First, enter the container:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker <span class="nb">exec</span> <span class="nt">-it</span> &lt;container <span class="nb">id</span><span class="o">&gt;</span> bash
</code></pre></div></div>

<p>Second, create a folder for holding the backup and additional files that we need:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir</span> /var/opt/gitlab/gitlab-backup
</code></pre></div></div>

<p>Now, generate a backup:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gitlab-backup create
</code></pre></div></div>

<p>After that, locate the backup, which is found under the
<code class="language-plaintext highlighter-rouge">/var/opt/gitlab/backups</code> folder, and transfer it to the backup folder:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cp</span> &lt;backup name&gt; /var/opt/gitlab/gitlab-backup
</code></pre></div></div>

<p>Now we need to find the additional files that I mentioned earlier. These are
<strong>gitlab-config.rb</strong> and <strong>gitlab-secrets.json</strong> files, which are found under the bind-mounted folder <strong>/var/opt/gitlab</strong>. Copy these files to the backup folder:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cp </span>gitlab-config.rb /var/opt/gitlab/gitlab-backup

<span class="nb">cp </span>gitlab-secrets.json /var/opt/gitlab/gitlab-backup
</code></pre></div></div>

<h2 id="transfer">Transfer</h2>
<p>Now that we have a backup of the GitLab repositories and the necessary configuration files, we can transfer these to the new machine.
There are several different ways the backup folder can be transferred to the new machine, we chose to transfer over the network as both our machines were connected to the same network.</p>

<p>To transfer the folder, you can use the <strong>scp</strong> command on the host machine as follows:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>scp <span class="nt">-r</span> &lt;location of /var/opt/gitlab on host machine&gt;/gitlab-backup &lt;new machine username&gt;@&lt;new machine ip address&gt;:&lt;~&gt;
</code></pre></div></div>

<h2 id="new-gitlab-container">New GitLab Container</h2>
<p>On the new machine, we need to create a new empty GitLab docker container. The
docker image used must be the same version as the previous image on the old machine.</p>

<blockquote>
  <p>Here Iâ€™m assuming the new machine has Docker installed. If not, please go ahead with installing Docker.</p>
</blockquote>

<p>Create the necessary folders to persist the data on the host machine:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir</span> ~/gitlab/config
<span class="nb">mkdir</span> ~/gitlab/data
<span class="nb">mkdir</span> ~/gitlab/log
</code></pre></div></div>

<p>Next, download and run the image:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker pull gitlab-ce:&lt;tag&gt;

docker run <span class="nt">-d</span> <span class="se">\</span>
	<span class="nt">-v</span> ./gitlab/config:/etc/gitlab <span class="se">\</span>
	<span class="nt">-v</span> ./gitlab/data:/var/opt/gitlab <span class="se">\</span>
	<span class="nt">-v</span> ./gitlab/log:/var/log/gitlab <span class="se">\</span>
	<span class="nt">-p</span> 80:80 <span class="se">\</span>
	gitlab-ce:&lt;tag&gt;
</code></pre></div></div>

<blockquote>
  <p>Wait here for the GitLab container to set itself up.</p>
</blockquote>

<h2 id="restore">Restore</h2>
<p>With the new GitLab docker image setup and running, we can transfer our backup files into the container.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cp</span> ~/gitlab-backup/&lt;backup name&gt; ~/gitlab/data/backups
<span class="nb">cp</span> ~/gitlab-backup/gitlab-config.rb ~/gitlab/config
<span class="nb">cp</span> ~/gitlab-backup/gitlab-secrets.json ~/gitlab/config
</code></pre></div></div>

<p>Finally, we can run the restore process inside the container:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker <span class="nb">exec</span> <span class="nt">-it</span> &lt;container <span class="nb">id</span><span class="o">&gt;</span> bash

gitlab-backup restore
</code></pre></div></div>

<p>With that, the transfer of the GitLab repositories is complete.
For us, the process of backing up our GitLab repositories can be improved
further by establishing an offsite backup as well.
However, for now, moving our GitLab to a NAS with RAID setup has already significantly improved our resilience to storage failure.</p>
:ET